<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blox Bux - Loja</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1 class="logo">Blox <span>Bux</span></h1>
    <nav>
      <button id="logoutBtn">Sair</button>
      <button id="adminBtn" class="hidden">Painel Admin</button>
    </nav>
  </header>

  <main>
    <h2 class="titulo">Produtos</h2>
    <div id="produtos" class="grid"></div>
  </main>

  <!-- Modal Admin -->
  <div id="adminModal" class="modal hidden">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2>Adicionar Produto</h2>
      <form id="addProductForm">
        <input type="text" id="produtoNome" placeholder="Nome do produto" required>
        <input type="text" id="produtoImagem" placeholder="URL da imagem" required>
        <input type="number" id="produtoPreco" placeholder="Preço (R$)" required>
        <button type="submit">Adicionar</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { app, auth } from "./firebase-config.js";
    import { getDatabase, ref, push, onValue, remove } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { onAuthStateChanged, signOut } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const db = getDatabase(app);
    const produtosRef = ref(db, "produtos");

    const produtosDiv = document.getElementById("produtos");
    const logoutBtn = document.getElementById("logoutBtn");
    const adminBtn = document.getElementById("adminBtn");
    const adminModal = document.getElementById("adminModal");
    const closeModal = document.getElementById("closeModal");
    const addProductForm = document.getElementById("addProductForm");

    let isAdmin = false;

    // Verifica usuário logado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        if (user.email === "marymartins5821@gmail.com") {
          isAdmin = true;
          adminBtn.classList.remove("hidden");
        }
      } else {
        window.location.href = "login.html";
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // Abrir/fechar modal admin
    adminBtn.addEventListener("click", () => adminModal.classList.remove("hidden"));
    closeModal.addEventListener("click", () => adminModal.classList.add("hidden"));

    // Adicionar produto
    addProductForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("produtoNome").value;
      const imagem = document.getElementById("produtoImagem").value;
      const preco = document.getElementById("produtoPreco").value;

      await push(produtosRef, { nome, imagem, preco });
      addProductForm.reset();
      adminModal.classList.add("hidden");
    });

    // Carregar produtos
    onValue(produtosRef, (snapshot) => {
      produtosDiv.innerHTML = "";
      snapshot.forEach((child) => {
        const key = child.key;
        const produto = child.val();

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${produto.imagem}" alt="${produto.nome}">
          <h3>${produto.nome}</h3>
          <p>R$ ${produto.preco}</p>
          <a href="https://wa.me/5548996354447?text=Quero%20comprar%20${encodeURIComponent(produto.nome)}" 
             target="_blank" class="btn">Comprar</a>
          ${isAdmin ? `<button class="btn-remove" data-id="${key}">Remover</button>` : ""}
        `;
        produtosDiv.appendChild(card);
      });

      if (isAdmin) {
        document.querySelectorAll(".btn-remove").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            await remove(ref(db, "produtos/" + id));
          });
        });
      }
    });
  </script>
</body>
</html>
