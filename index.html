<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blox Bux - Loja</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="firebase-config.js"></script>
</head>
<body class="main-body">

  <!-- Navbar -->
  <header class="navbar">
    <h1 class="logo">Blox Bux</h1>
    <nav>
      <button class="nav-btn" onclick="mostrarAba('conta')">Minha Conta</button>
      <button class="nav-btn" onclick="mostrarAba('produtos')">Produtos</button>
      <button class="nav-btn logout-btn" id="logout">Sair</button>
    </nav>
  </header>

  <!-- Conteúdo -->
  <main>
    <!-- Aba Conta -->
    <section id="conta" class="aba ativa">
      <h2>Minha Conta</h2>
      <p><strong>Email:</strong> <span id="user-email"></span></p>
      <p><strong>Status:</strong> <span id="user-status"></span></p>
    </section>

    <!-- Aba Produtos -->
    <section id="produtos" class="aba">
      <h2>Produtos</h2>
      <div id="products-list" class="products-grid"></div>

      <!-- Admin apenas -->
      <div id="admin-panel" class="admin-panel hidden">
        <h3>Adicionar Produto</h3>
        <form id="product-form">
          <input type="text" id="product-name" placeholder="Nome do Produto" required>
          <input type="number" id="product-price" placeholder="Preço (R$)" required>
          <button type="submit" class="btn">Adicionar</button>
        </form>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db, ref, set, onValue, remove, signOut } from "./firebase-config.js";

    const userEmailSpan = document.getElementById("user-email");
    const userStatusSpan = document.getElementById("user-status");
    const productsList = document.getElementById("products-list");
    const adminPanel = document.getElementById("admin-panel");

    let currentUserEmail = "";

    // Alternar abas
    window.mostrarAba = (aba) => {
      document.querySelectorAll(".aba").forEach(sec => sec.classList.remove("ativa"));
      document.getElementById(aba).classList.add("ativa");
    };

    // Autenticação
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserEmail = user.email;
        userEmailSpan.textContent = user.email;
        userStatusSpan.textContent = user.email === "marymartins5821@gmail.com" ? "Administrador" : "Usuário";

        if (user.email === "marymartins5821@gmail.com") {
          adminPanel.classList.remove("hidden");
        }

        carregarProdutos();
      } else {
        window.location.href = "login.html";
      }
    });

    // Logout
    document.getElementById("logout").addEventListener("click", () => {
      signOut(auth).then(() => window.location.href = "login.html");
    });

    // Adicionar produto
    document.getElementById("product-form").addEventListener("submit", e => {
      e.preventDefault();
      const nome = document.getElementById("product-name").value;
      const preco = document.getElementById("product-price").value;

      const newKey = Date.now();
      set(ref(db, "produtos/" + newKey), { nome, preco }).then(() => {
        e.target.reset();
      });
    });

    // Carregar produtos
    function carregarProdutos() {
      onValue(ref(db, "produtos/"), snapshot => {
        const data = snapshot.val() || {};
        productsList.innerHTML = "";

        Object.keys(data).forEach(key => {
          const produto = data[key];
          let removerBtn = "";

          if (currentUserEmail === "marymartins5821@gmail.com") {
            removerBtn = `<button class="btn secondary remove-btn" data-key="${key}">Remover</button>`;
          }

          productsList.innerHTML += `
            <div class="product-card">
              <h3>${produto.nome}</h3>
              <p>R$ ${produto.preco}</p>
              <div class="product-buttons">
                <a href="compra.html?produto=${encodeURIComponent(produto.nome)}">
                  <button class="btn">Comprar</button>
                </a>
                ${removerBtn}
              </div>
            </div>
          `;
        });

        document.querySelectorAll(".remove-btn").forEach(btn => {
          btn.addEventListener("click", e => {
            const key = e.target.getAttribute("data-key");
            remove(ref(db, "produtos/" + key));
          });
        });
      });
    }
  </script>
</body>
</html>
